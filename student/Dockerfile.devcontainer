# -----------------------------------------------------------------------------
# Dockerfile.devcontainer
# Entorno de desarrollo universal para K3D-LAKEHOUSE
# Público – NO contiene secretos ni lógica privada
# -----------------------------------------------------------------------------

FROM ubuntu:22.04

SHELL ["/bin/bash", "-c"]

# --------------------------------------------------------------------------
# 1. Paquetes base
# --------------------------------------------------------------------------
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    curl \
    wget \
    git \
    unzip \
    iputils-ping \
    net-tools \
    dnsutils \
    apt-transport-https \
    software-properties-common \
    ca-certificates \
    lsb-release \
    jq \
    sudo \
    bash-completion \
    vim \
    nano \
    htop \
    python3 \
    python3-pip \
    openssh-client \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------------------------
# 2. Instalar Docker CLI (sin daemon)
#    Codespace/Gitpod usa Docker remoto por defecto
# --------------------------------------------------------------------------
RUN curl -fsSL https://get.docker.com | bash

# --------------------------------------------------------------------------
# 3. Instalar kubectl + helm
# --------------------------------------------------------------------------

# kubectl estable
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && install -m 0755 kubectl /usr/local/bin/kubectl \
    && rm kubectl

# helm estable
RUN curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

# --------------------------------------------------------------------------
# 4. Instalar k3d
# --------------------------------------------------------------------------
RUN curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

# --------------------------------------------------------------------------
# 5. Crear usuario estándar (opcional)
# --------------------------------------------------------------------------
ARG USERNAME=z2h
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && usermod -aG sudo $USERNAME \
    && usermod -aG docker $USERNAME \
    && echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER $USERNAME
WORKDIR /home/$USERNAME

# --------------------------------------------------------------------------
# 6. Instalar Python tools mínimas (opcional)
# --------------------------------------------------------------------------
RUN pip install --no-cache-dir \
    requests \
    pyyaml \
    rich

# --------------------------------------------------------------------------
# 7. Mensaje final
# --------------------------------------------------------------------------
RUN echo 'Devcontainer for K3D-LAKEHOUSE ready.' > /home/$USERNAME/READY.txt

CMD [ "bash" ]
